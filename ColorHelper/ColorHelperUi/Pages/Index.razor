@page "/"
@using ColorService
@using ColorService.Models
@using MudBlazor.Utilities
@inject IColorService ColorService
@inject IPaintService PaintService
@inject IBrandService BrandService

<MudContainer>
    
    <MudText Typo="Typo.h4" Align="Align.Center" GutterBottom="true" class="mt-10">Find Closest Paints</MudText>
    <MudText Typo="Typo.body1" Align="Align.Center" GutterBottom="true">Select or input a given color and the 5 closest known colors will be listed</MudText>
    <MudDivider class="mb-10"></MudDivider>
    
    
    <MudGrid>
        <MudItem xs="12" sm="6" md="6">
            <MudPaper Elevation="2" Class="pa-4" style="min-height:470px;">
                <MudStack Justify="Justify.Center" AlignItems="AlignItems.Center">
                    <MudAutocomplete T="Paint" 
                                     Label="Paint Name" 
                                     SearchFunc="@SearchForPaint"
                                     ValueChanged="@SearchValueChanged"
                                     Clearable="true"
                                     ToStringFunc="@(e=> e.Name + " - " + e.Brand)"
                                     ResetValueOnEmptyText="true"
                                     Style="width: 300px"
                                     AdornmentIcon="@Icons.Material.Filled.Search" AdornmentColor="Color.Primary" />
                    
                    <MudColorPicker @ref="_colorPicker" 
                                    class="object-center" 
                                    PickerVariant="PickerVariant.Static" 
                                    DisableAlpha="true" 
                                    DisablePreview="true" 
                                    ValueChanged="GetClosestPaints"/>
                </MudStack>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="6">
            <MudPaper Elevation="2" Class="pa-4 pt-7" style="min-height:470px;">
                <MudStack Justify="Justify.Center" AlignItems="AlignItems.Center">
                    <MudChipSet @bind-SelectedChips="_selectedBrandFilters"
                                SelectedValuesChanged="SelectedValuesChanged" MultiSelection="true" Filter="true">
                        @foreach (var brand in Brands)
                        {
                            <MudChip Text="@brand" Default="true"></MudChip>
                        }
                    </MudChipSet>
                    <MudSimpleTable Style="width: 90%">
                        <thead>
                            <tr>
                                <th>Brand</th>
                                <th>Name</th>
                                <th>Sample</th>
                            </tr>
                        </thead>
                        <tbody>
                        @foreach (var paint in ClosestPaints)
                        {
                            <tr>
                                <td>@paint.Brand</td>
                                <td>@paint.Name</td>
                                <td style="background-color: rgb(@paint.Rgb.R, @paint.Rgb.G, @paint.Rgb.B)"></td>
                            </tr>
                        }
                        </tbody>
                    </MudSimpleTable>
                </MudStack>
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>


@code {

    private IList<Paint> ClosestPaints { get; set; } = new List<Paint>();
    private IList<string> Brands { get; set; } = new List<string>();

    private MudChip[] _selectedBrandFilters = Array.Empty<MudChip>();
    private MudColorPicker _colorPicker = default!;
    private MudColor _selectedColor = default!;

    protected override async Task OnInitializedAsync()
    {
        Brands = await BrandService.GetBrands();
        _selectedBrandFilters = new MudChip[Brands.Count];
    }
    
    private async void GetClosestPaints(MudColor? selectedColor)
    {
        if (selectedColor == null) return;
        
        _selectedColor = selectedColor;
        ClosestPaints = await ColorService.GetClosestPaints(selectedColor.R, selectedColor.G, selectedColor.B, _selectedBrandFilters.Select(x => x.Text).ToList());
        StateHasChanged();
    }

    private async Task<IEnumerable<Paint>> SearchForPaint(string searchTerm)
    {
        if (string.IsNullOrEmpty(searchTerm))
        {
            return new List<Paint>();
        }
        
        var result = await PaintService.GetPaint(searchTerm);

        return !result.Any() ? new List<Paint>() : result;
    }

    private void SearchValueChanged(Paint? newValue)
    {
        if (newValue == null) return;
        _colorPicker.SetR(newValue.Rgb.R);
        _colorPicker.SetG(newValue.Rgb.G);
        _colorPicker.SetB(newValue.Rgb.B);
    }

    private void SelectedValuesChanged()
    {
        GetClosestPaints(_selectedColor);
    }

}